(function(a){var b,c,d;if(typeof window==="undefined"){b=require("underscore");c=require("backbone");d=module.exports=c}else{var b=window._;c=window.Backbone;d=window}c.Relational={showWarnings:true};c.Semaphore={_permitsAvailable:null,_permitsUsed:0,acquire:function(){if(this._permitsAvailable&&this._permitsUsed>=this._permitsAvailable){throw new Error("Max permits acquired")}else{this._permitsUsed++}},release:function(){if(this._permitsUsed===0){throw new Error("All permits released")}else{this._permitsUsed--}},isLocked:function(){return this._permitsUsed>0},setAvailablePermits:function(a){if(this._permitsUsed>a){throw new Error("Available permits cannot be less than used permits")}this._permitsAvailable=a}};c.BlockingQueue=function(){this._queue=[]};b.extend(c.BlockingQueue.prototype,c.Semaphore,{_queue:null,add:function(a){if(this.isBlocked()){this._queue.push(a)}else{a()}},process:function(){while(this._queue&&this._queue.length){this._queue.shift()()}},block:function(){this.acquire()},unblock:function(){this.release();if(!this.isBlocked()){this.process()}},isBlocked:function(){return this.isLocked()}});c.Relational.eventQueue=new c.BlockingQueue;c.Store=function(){this._collections=[];this._reverseRelations=[]};b.extend(c.Store.prototype,c.Events,{_collections:null,_reverseRelations:null,addReverseRelation:function(a){var c=b.any(this._reverseRelations,function(c){return b.all(a,function(a,b){return a===c[b]})});if(!c&&a.model&&a.type){this._reverseRelations.push(a);if(!a.model.prototype.relations){a.model.prototype.relations=[]}a.model.prototype.relations.push(a);this.retroFitRelation(a)}},retroFitRelation:function(a){var b=this.getCollection(a.model);b.each(function(b){new a.type(b,a)},this)},getCollection:function(a){var c=b.detect(this._collections,function(b){return a===b.model||a.constructor===b.model});if(!c){c=this._createCollection(a)}return c},getObjectByName:function(a){var c=b.reduce(a.split("."),function(a,b){return a[b]},d);return c!==d?c:null},_createCollection:function(a){var b;if(a instanceof c.RelationalModel){a=a.constructor}if(a.prototype instanceof c.RelationalModel.prototype.constructor){b=new c.Collection;b.model=a;this._collections.push(b)}return b},find:function(a,b){var c=this.getCollection(a);return c&&c.get(b)},register:function(a){var b=a.collection;var c=this.getCollection(a);c&&c.add(a);a.bind("destroy",this.unregister,this);a.collection=b},update:function(a){var b=this.getCollection(a);b._onModelEvent("change:"+a.idAttribute,a,b)},unregister:function(a){a.unbind("destroy",this.unregister);var b=this.getCollection(a);b&&b.remove(a)}});c.Relational.store=new c.Store;c.Relation=function(a,d){this.instance=a;d=typeof d==="object"&&d||{};this.reverseRelation=b.defaults(d.reverseRelation||{},this.options.reverseRelation);this.reverseRelation.type=!b.isString(this.reverseRelation.type)?this.reverseRelation.type:c[this.reverseRelation.type]||c.Relational.store.getObjectByName(this.reverseRelation.type);this.model=d.model||this.instance.constructor;this.options=b.defaults(d,this.options,c.Relation.prototype.options);this.key=this.options.key;this.relatedModel=this.options.relatedModel;if(b.isString(this.relatedModel)){this.relatedModel=c.Relational.store.getObjectByName(this.relatedModel)}if(!this.checkPreconditions()){return false}if(a){this.keyContents=this.instance.get(this.key);this.instance._relations.push(this)}if(!this.options.isAutoRelation&&this.reverseRelation.type&&this.reverseRelation.key){c.Relational.store.addReverseRelation(b.defaults({isAutoRelation:true,model:this.relatedModel,relatedModel:this.model,reverseRelation:this.options},this.reverseRelation))}b.bindAll(this,"_modelRemovedFromCollection","_relatedModelAdded","_relatedModelRemoved");if(a){this.initialize();c.Relational.store.getCollection(this.instance).bind("relational:remove",this._modelRemovedFromCollection);c.Relational.store.getCollection(this.relatedModel).bind("relational:add",this._relatedModelAdded).bind("relational:remove",this._relatedModelRemoved)}};c.Relation.extend=c.Model.extend;b.extend(c.Relation.prototype,c.Events,c.Semaphore,{options:{createModels:true,includeInJSON:true,isAutoRelation:false},instance:null,key:null,keyContents:null,relatedModel:null,reverseRelation:null,related:null,_relatedModelAdded:function(a,b,c){var d=this;a.queue(function(){d.tryAddRelated(a,c)})},_relatedModelRemoved:function(a,b,c){this.removeRelated(a,c)},_modelRemovedFromCollection:function(a){if(a===this.instance){this.destroy()}},checkPreconditions:function(){var a=this.instance,d=this.key,e=this.model,f=this.relatedModel,g=c.Relational.showWarnings;if(!e||!d||!f){g&&typeof console!=="undefined"&&console.warn("Relation=%o; no model, key or relatedModel (%o, %o, %o)",this,d,f);return false}if(!(e.prototype instanceof c.RelationalModel.prototype.constructor)){g&&typeof console!=="undefined"&&console.warn("Relation=%o; model does not inherit from Backbone.RelationalModel (%o)",this,a);return false}if(!(f.prototype instanceof c.RelationalModel.prototype.constructor)){g&&typeof console!=="undefined"&&console.warn("Relation=%o; relatedModel does not inherit from Backbone.RelationalModel (%o)",this,f);return false}if(this instanceof c.HasMany&&this.reverseRelation.type===c.HasMany.prototype.constructor){g&&typeof console!=="undefined"&&console.warn("Relation=%o; relation is a HasMany, and the reverseRelation is HasMany as well.",this);return false}if(a){if(a._relations.length){var h=b.any(a._relations,function(a){var b=this.reverseRelation.key&&a.reverseRelation.key;return a.relatedModel===f&&a.key===d&&(!b||this.reverseRelation.key===a.reverseRelation.key)},this);if(h){g&&typeof console!=="undefined"&&console.warn("Relation=%o between instance=%o.%s and relatedModel=%o.%s already exists",this,a,d,f,this.reverseRelation.key);return false}}}return true},setRelated:function(a,c){this.related=a;var d={};d[this.key]=a;this.instance.acquire();this.instance.set(d,b.defaults(c||{},{silent:true}));this.instance.release()},createModel:function(a){if(this.options.createModels&&typeof a==="object"){return new this.relatedModel(a)}},_isReverseRelation:function(a){if(a.instance instanceof this.relatedModel&&this.reverseRelation.key===a.key&&this.key===a.reverseRelation.key){return true}return false},getReverseRelations:function(a){var c=[];var d=!b.isUndefined(a)?[a]:this.related&&(this.related.models||[this.related]);b.each(d,function(a){b.each(a.getRelations(),function(a){if(this._isReverseRelation(a)){c.push(a)}},this)},this);return c},sanitizeOptions:function(a){a||(a={});if(a.silent){a=b.extend({},a,{silentChange:true});delete a.silent}return a},destroy:function(){c.Relational.store.getCollection(this.instance).unbind("relational:remove",this._modelRemovedFromCollection);c.Relational.store.getCollection(this.relatedModel).unbind("relational:add",this._relatedModelAdded).unbind("relational:remove",this._relatedModelRemoved);b.each(this.getReverseRelations(),function(a){a.removeRelated(this.instance)},this)}});c.HasOne=c.Relation.extend({options:{reverseRelation:{type:"HasMany"}},initialize:function(){b.bindAll(this,"onChange");this.instance.bind("relational:change:"+this.key,this.onChange);var a=this.findRelated({silent:true});this.setRelated(a);var c=this;b.each(c.getReverseRelations(),function(a){a.addRelated(c.instance)})},findRelated:function(a){var d=this.keyContents;var e=null;if(d instanceof this.relatedModel){e=d}else if(d&&(b.isString(d)||b.isNumber(d)||typeof d==="object")){var f=b.isString(d)||b.isNumber(d)?d:d[this.relatedModel.prototype.idAttribute];e=c.Relational.store.find(this.relatedModel,f);if(e&&b.isObject(d)){e.set(d,a)}else if(!e){e=this.createModel(d)}}return e},onChange:function(a,d,e){if(this.isLocked()){return}this.acquire();e=this.sanitizeOptions(e);var f=b.isUndefined(e._related);var g=f?this.related:e._related;if(f){this.keyContents=d;if(d instanceof this.relatedModel){this.related=d}else if(d){var h=this.findRelated(e);this.setRelated(h)}else{this.setRelated(null)}}if(g&&this.related!==g){b.each(this.getReverseRelations(g),function(a){a.removeRelated(this.instance,e)},this)}b.each(this.getReverseRelations(),function(a){a.addRelated(this.instance,e)},this);if(!e.silentChange&&this.related!==g){var i=this;c.Relational.eventQueue.add(function(){i.instance.trigger("update:"+i.key,i.instance,i.related,e)})}this.release()},tryAddRelated:function(a,c){if(this.related){return}c=this.sanitizeOptions(c);var d=this.keyContents;if(d&&(b.isString(d)||b.isNumber(d)||typeof d==="object")){var e=b.isString(d)||b.isNumber(d)?d:d[this.relatedModel.prototype.idAttribute];if(a.id===e){this.addRelated(a,c)}}},addRelated:function(a,b){if(a!==this.related){var c=this.related||null;this.setRelated(a);this.onChange(this.instance,a,{_related:c})}},removeRelated:function(a,b){if(!this.related){return}if(a===this.related){var c=this.related||null;this.setRelated(null);this.onChange(this.instance,a,{_related:c})}}});c.HasMany=c.Relation.extend({collectionType:null,options:{reverseRelation:{type:"HasOne"},collectionType:c.Collection,collectionKey:true},initialize:function(){b.bindAll(this,"onChange","handleAddition","handleRemoval","handleReset");this.instance.bind("relational:change:"+this.key,this.onChange);this.collectionType=this.options.collectionType;if(b(this.collectionType).isString()){this.collectionType=c.Relational.store.getObjectByName(this.collectionType)}if(!this.collectionType.prototype instanceof c.Collection.prototype.constructor){throw new Error("collectionType must inherit from Backbone.Collection")}this.setRelated(this.prepareCollection(new this.collectionType));this.findRelated({silent:true})},prepareCollection:function(a){if(this.related){this.related.unbind("relational:add",this.handleAddition).unbind("relational:remove",this.handleRemoval).unbind("relational:reset",this.handleReset)}a.reset();a.model=this.relatedModel;if(this.options.collectionKey){var b=this.options.collectionKey===true?this.options.reverseRelation.key:this.options.collectionKey;if(a[b]&&a[b]!==this.instance){if(c.Relational.showWarnings&&typeof console!=="undefined"){console.warn("Relation=%o; collectionKey=%s already exists on collection=%o",this,b,this.options.collectionKey)}}else{a[b]=this.instance}}a.bind("relational:add",this.handleAddition).bind("relational:remove",this.handleRemoval).bind("relational:reset",this.handleReset);return a},findRelated:function(a){if(this.keyContents){this.keyContents=b.isArray(this.keyContents)?this.keyContents:[this.keyContents];b.each(this.keyContents,function(d){var e=b.isString(d)||b.isNumber(d)?d:d[this.relatedModel.prototype.idAttribute];var f=c.Relational.store.find(this.relatedModel,e);if(f&&b.isObject(d)){f.set(d,a)}else if(!f){f=this.createModel(d)}if(f&&!this.related.getByCid(f)&&!this.related.get(f)){this.related.add(f)}},this)}},onChange:function(a,d,e){e=this.sanitizeOptions(e);this.keyContents=d;b.each(this.getReverseRelations(),function(a){a.removeRelated(this.instance,e)},this);if(d instanceof c.Collection){this.prepareCollection(d);this.related=d}else{var f=this.related instanceof c.Collection?this.related:new this.collectionType;this.setRelated(this.prepareCollection(f));this.findRelated(e)}b.each(this.getReverseRelations(),function(a){a.addRelated(this.instance,e)},this);var g=this;c.Relational.eventQueue.add(function(){!e.silentChange&&g.instance.trigger("update:"+g.key,g.instance,g.related,e)})},tryAddRelated:function(a,c){c=this.sanitizeOptions(c);if(!this.related.getByCid(a)&&!this.related.get(a)){var d=b.any(this.keyContents,function(c){var d=b.isString(c)||b.isNumber(c)?c:c[this.relatedModel.prototype.idAttribute];return d&&d===a.id},this);if(d){this.related.add(a,c)}}},handleAddition:function(a,d,e){if(!(a instanceof c.Model)){return}e=this.sanitizeOptions(e);b.each(this.getReverseRelations(a),function(a){a.addRelated(this.instance,e)},this);var f=this;c.Relational.eventQueue.add(function(){!e.silentChange&&f.instance.trigger("add:"+f.key,a,f.related,e)})},handleRemoval:function(a,d,e){if(!(a instanceof c.Model)){return}e=this.sanitizeOptions(e);b.each(this.getReverseRelations(a),function(a){a.removeRelated(this.instance,e)},this);var f=this;c.Relational.eventQueue.add(function(){!e.silentChange&&f.instance.trigger("remove:"+f.key,a,f.related,e)})},handleReset:function(a,b){b=this.sanitizeOptions(b);var d=this;c.Relational.eventQueue.add(function(){!b.silentChange&&d.instance.trigger("reset:"+d.key,d.related,b)})},addRelated:function(a,b){var c=this;a.queue(function(){if(c.related&&!c.related.getByCid(a)&&!c.related.get(a)){c.related.add(a,b)}})},removeRelated:function(a,b){if(this.related.getByCid(a)||this.related.get(a)){this.related.remove(a,b)}}});c.RelationalModel=c.Model.extend({relations:null,_relations:null,_isInitialized:false,_deferProcessing:false,_queue:null,constructor:function(a,d){var e=this;if(d&&d.collection){this._deferProcessing=true;var f=function(a){if(a===e){e._deferProcessing=false;e.processQueue();d.collection.unbind("relational:add",f)}};d.collection.bind("relational:add",f);b.defer(function(){f(e)})}this._queue=new c.BlockingQueue;this._queue.block();c.Relational.eventQueue.block();c.Model.prototype.constructor.apply(this,arguments);c.Relational.eventQueue.unblock()},trigger:function(a){if(a.length>5&&"change"===a.substr(0,6)){var b=this,d=arguments;c.Relational.eventQueue.add(function(){c.Model.prototype.trigger.apply(b,d)})}else{c.Model.prototype.trigger.apply(this,arguments)}return this},initializeRelations:function(){this.acquire();this._relations=[];b.each(this.relations,function(a){var d=!b.isString(a.type)?a.type:c[a.type]||c.Relational.store.getObjectByName(a.type);if(d&&d.prototype instanceof c.Relation.prototype.constructor){new d(this,a)}else{c.Relational.showWarnings&&typeof console!=="undefined"&&console.warn("Relation=%o; missing or invalid type!",a)}},this);this._isInitialized=true;this.release();this.processQueue()},updateRelations:function(a){if(this._isInitialized&&!this.isLocked()){b.each(this._relations,function(b){var c=this.attributes[b.key];if(b.related!==c){this.trigger("relational:change:"+b.key,this,c,a||{})}},this)}},queue:function(a){this._queue.add(a)},processQueue:function(){if(this._isInitialized&&!this._deferProcessing&&this._queue.isBlocked()){this._queue.unblock()}},getRelation:function(a){return b.detect(this._relations,function(b){if(b.key===a){return true}},this)},getRelations:function(){return this._relations},fetchRelated:function(a,d){d||(d={});var e,f=[],g=this.getRelation(a),h=g&&g.keyContents,i=h&&b.select(b.isArray(h)?h:[h],function(a){var d=b.isString(a)||b.isNumber(a)?a:a[g.relatedModel.prototype.idAttribute];return d&&!c.Relational.store.find(g.relatedModel,d)},this);if(i&&i.length){var j=b.map(i,function(a){var b;if(typeof a==="object"){b=new g.relatedModel(a)}else{var c={};c[g.relatedModel.prototype.idAttribute]=a;b=new g.relatedModel(c)}return b},this);if(g.related instanceof c.Collection&&b.isFunction(g.related.url)){e=g.related.url(j)}if(e&&e!==g.related.url()){var k=b.defaults({error:function(){var a=arguments;b.each(j,function(b){b.trigger("destroy",b,b.collection,d);d.error&&d.error.apply(b,a)})},url:e},d,{add:true});f=[g.related.fetch(k)]}else{f=b.map(j,function(a){var c=b.defaults({error:function(){a.trigger("destroy",a,a.collection,d);d.error&&d.error.apply(a,arguments)}},d);return a.fetch(c)},this)}}return f},set:function(a,d,e){c.Relational.eventQueue.block();var f;if(b.isObject(a)||a==null){f=a;e=d}else{f={};f[a]=d}var g=c.Model.prototype.set.apply(this,arguments);if(!this._isInitialized&&!this.isLocked()){c.Relational.store.register(this);this.initializeRelations()}else if(f&&this.idAttribute in f){c.Relational.store.update(this)}if(f){this.updateRelations(e)}c.Relational.eventQueue.unblock();return g},unset:function(a,b){c.Relational.eventQueue.block();var d=c.Model.prototype.unset.apply(this,arguments);this.updateRelations(b);c.Relational.eventQueue.unblock();return d},clear:function(a){c.Relational.eventQueue.block();var b=c.Model.prototype.clear.apply(this,arguments);this.updateRelations(a);c.Relational.eventQueue.unblock();return b},change:function(a){var b=this;c.Relational.eventQueue.add(function(){c.Model.prototype.change.apply(b,arguments)})},clone:function(){var a=b.clone(this.attributes);if(!b.isUndefined(a[this.idAttribute])){a[this.idAttribute]=null}b.each(this.getRelations(),function(b){delete a[b.key]});return new this.constructor(a)},toJSON:function(){if(this.isLocked()){return this.id}this.acquire();var a=c.Model.prototype.toJSON.call(this);b.each(this._relations,function(d){var e=a[d.key];if(d.options.includeInJSON===true&&e&&b.isFunction(e.toJSON)){a[d.key]=e.toJSON()}else if(b.isString(d.options.includeInJSON)){if(e instanceof c.Collection){a[d.key]=e.pluck(d.options.includeInJSON)}else if(e instanceof c.Model){a[d.key]=e.get(d.options.includeInJSON)}}else{delete a[d.key]}},this);this.release();return a}});b.extend(c.RelationalModel.prototype,c.Semaphore);var e=c.Collection.prototype.add;c.Collection.prototype.add=function(a,d){d||(d={});if(!b.isArray(a)){a=[a]}b.each(a,function(a){if(!(a instanceof c.Model)){var b=c.Relational.store.find(this.model,a[this.model.prototype.idAttribute]);if(b){b.set(a,d);a=b}else{a=c.Collection.prototype._prepareModel.call(this,a,d)}}if(a instanceof c.Model&&!this.get(a)&&!this.getByCid(a)){e.call(this,a,d);this.trigger("relational:add",a,this,d)}},this);return this};var f=c.Collection.prototype.remove;c.Collection.prototype.remove=function(a,d){d||(d={});if(!b.isArray(a)){a=[a]}b.each(a,function(a){a=this.getByCid(a)||this.get(a);if(a instanceof c.Model){f.call(this,a,d);this.trigger("relational:remove",a,this,d)}},this);return this};var g=c.Collection.prototype.reset;c.Collection.prototype.reset=function(a,b){g.call(this,a,b);this.trigger("relational:reset",a,b);return this};var h=c.Collection.prototype.trigger;c.Collection.prototype.trigger=function(a){if(a==="add"||a==="remove"||a==="reset"){var b=this,d=arguments;c.Relational.eventQueue.add(function(){h.apply(b,d)})}else{h.apply(this,arguments)}return this};c.RelationalModel.extend=function(a,d){var e=c.Model.extend.apply(this,arguments);var f=a&&a.relations||[];b.each(f,function(a){if(a.reverseRelation){a.model=e;var d=true;if(b.isString(a.relatedModel)){var f=c.Relational.store.getObjectByName(a.relatedModel);d=f&&f.prototype instanceof c.RelationalModel.prototype.constructor}var g=!b.isString(a.type)?a.type:c[a.type]||c.Relational.store.getObjectByName(a.type);if(d&&g&&g.prototype instanceof c.Relation.prototype.constructor){new g(null,a)}}});return e}})()